{
  "hooks": {
    "SessionStart": [
      {
        "hooks": [
          {
            "type": "command",
            "command": "python3 -c \"import json,sys,os,subprocess; d=json.load(sys.stdin); sid=d.get('session_id',''); cwd=d.get('cwd','.'); (open('/tmp/.claude_main_session','w').write(sid) if sid else None); rec=os.path.join(cwd,'.claude/recording.md'); sys.exit(0) if not os.path.exists(os.path.dirname(rec)) else None; now=subprocess.check_output(['date','+%Y-%m-%d %H:%M:%S']).decode().strip(); f=os.path.join(cwd,'.claude/task.json'); tasks=(json.load(open(f)).get('tasks',[]) if os.path.exists(f) else []); lines=[('- '+t['status']+': Task#'+str(t['id'])+' '+t.get('title',t.get('description',''))[:40]) for t in tasks if t['status'] not in ('Done','Cancelled')]; dc=sum(1 for t in tasks if t['status']=='Done'); (lines.append('- Done: '+str(dc)+' 个') if dc else None); snap=(chr(10).join(lines) if lines else '- 无进行中任务'); open(rec,'a').write(chr(10)+'---'+chr(10)+'## Session Start '+now+chr(10)+chr(10)+snap+chr(10))\" 2>/dev/null||true"
          }
        ]
      }
    ],
    "PreToolUse": [
      {
        "matcher": "Bash",
        "hooks": [
          {
            "type": "command",
            "command": "python3 -c \"import json,sys,os; f='.claude/task.json'; d=json.load(open(f)) if os.path.exists(f) else sys.exit(0); t=next((x for x in d['tasks'] if x['status']=='InProgress'),None); t and print('[diwu] Task#'+str(t['id'])+': '+t.get('title',t.get('description',''))+((chr(10)+'  说明: '+t['description']) if t.get('description') else '')+chr(10)+chr(10).join('  - '+a for a in t.get('acceptance',[])))\" 2>/dev/null||true"
          }
        ]
      }
    ],
    "SubagentStop": [
      {
        "hooks": [
          {
            "type": "command",
            "command": "python3 -c \"import json,sys,os,subprocess; d=json.load(sys.stdin); sid=d.get('session_id',''); main=open('/tmp/.claude_main_session').read().strip() if os.path.exists('/tmp/.claude_main_session') else ''; sys.exit(0) if sid!=main or not sid else None; f='.claude/task.json'; tasks=json.load(open(f)).get('tasks',[]) if os.path.exists(f) else sys.exit(0); t=next((x for x in tasks if x['status']=='InProgress'),None); sys.exit(0) if not t else None; now=subprocess.check_output(['date','+%Y-%m-%d %H:%M:%S']).decode().strip(); print(json.dumps({'continue':True,'additionalSystemPrompt':'子代理已完成，请立即将当前进度写入 .claude/recording.md。时间戳直接使用：'+now+'（禁止伪造）。任务：Task#'+str(t['id'])+' '+t.get('title',t.get('description',''))+'。任务描述：'+t.get('description','')+'。格式遵循 templates.md Session 格式。只写 recording.md，完成后停止。'}))\" 2>/dev/null||true"
          }
        ]
      }
    ],
    "Stop": [
      {
        "hooks": [
          {
            "type": "command",
            "command": "python3 -c \"import json,sys,os,subprocess; d=json.load(sys.stdin); cwd=d.get('cwd','.'); rec=os.path.join(cwd,'.claude/recording.md'); sys.exit(0) if not os.path.exists(os.path.dirname(rec)) else None; now=subprocess.check_output(['date','+%Y-%m-%d %H:%M:%S']).decode().strip(); f=os.path.join(cwd,'.claude/task.json'); tasks=(json.load(open(f)).get('tasks',[]) if os.path.exists(f) else []); lines=[('- '+t['status']+': Task#'+str(t['id'])+' '+t.get('title',t.get('description',''))[:40]) for t in tasks if t['status'] not in ('Done','Cancelled')]; dc=sum(1 for t in tasks if t['status']=='Done'); (lines.append('- Done: '+str(dc)+' 个') if dc else None); snap=(chr(10).join(lines) if lines else '- 无进行中任务'); open(rec,'a').write(chr(10)+'## Session End '+now+chr(10)+chr(10)+snap+chr(10))\" 2>/dev/null||true",
            "run_in_background": true
          }
        ]
      },
      {
        "hooks": [
          {
            "type": "command",
            "command": "python3 -c \"import json,sys,os,platform; notify=lambda msg: (os.system('osascript -e \\\"display notification \\\\\\\"'+msg+'\\\\\\\" with title \\\\\\\"diwu-workflow\\\\\\\" sound name \\\\\\\"Glass\\\\\\\"\\\" 2>/dev/null') if platform.system()=='Darwin' else os.system('notify-send \\\"diwu-workflow\\\" \\\"'+msg+'\\\" 2>/dev/null')) or (open('/dev/tty','w').write('\\a') if os.path.exists('/dev/tty') else os.system('osascript -e \"beep\" 2>/dev/null')); f='.claude/task.json'; tasks=json.load(open(f)).get('tasks',[]) if os.path.exists(f) else sys.exit(0); done_ids={t['id'] for t in tasks if t['status']=='Done'}; is_unblocked=lambda t: all(bid in done_ids for bid in t.get('blocked_by',[])); mk=lambda prefix,t: prefix+chr(10)+chr(10)+'Task#'+str(t['id'])+': '+t.get('title',t.get('description',''))+chr(10)+'任务描述：'+t.get('description','')+chr(10)+chr(10)+'验收条件：'+chr(10)+chr(10).join('  - '+a for a in t.get('acceptance',[]))+chr(10)+chr(10)+'实施步骤：'+chr(10)+chr(10).join('  '+str(i+1)+'. '+s for i,s in enumerate(t.get('steps',[])))+chr(10)+chr(10)+'按 core-workflow.md 流程执行。'; ip=[t for t in tasks if t['status']=='InProgress']; rc=sum(1 for t in tasks if t['status']=='InReview'); nx=[t for t in tasks if t['status']=='InSpec' and is_unblocked(t)]; (print(json.dumps({'decision':'block','reason':mk('继续完成当前任务：',ip[0])})) or sys.exit(0)) if ip else (notify('InReview 任务已达 '+str(rc)+' 个，请人工验收后继续') or sys.exit(0)) if rc>5 else ((print(json.dumps({'decision':'block','reason':mk('继续执行下一个任务：',nx[0])})) or sys.exit(0)) if nx else (notify('所有任务已完成') or sys.exit(0)))\" 2>/dev/null||true"
          }
        ]
      }
    ]
  }
}
