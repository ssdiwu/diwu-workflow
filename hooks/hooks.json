{
  "hooks": {
    "SessionStart": [
      {
        "hooks": [
          {
            "type": "command",
            "command": "python3 -c \"import json,sys; d=json.load(sys.stdin); sid=d.get('session_id',''); open('/tmp/.claude_main_session','w').write(sid) if sid else None\" 2>/dev/null||true"
          }
        ]
      }
    ],
    "PreToolUse": [
      {
        "matcher": "Bash",
        "hooks": [
          {
            "type": "command",
            "command": "python3 -c \"import json,sys,os; f='.claude/task.json'; d=json.load(open(f)) if os.path.exists(f) else sys.exit(0); t=next((x for x in d['tasks'] if x['status']=='InProgress'),None); t and print('[diwu] Task#'+str(t['id'])+': '+t['description']+chr(10)+chr(10).join('  - '+a for a in t['acceptance']))\" 2>/dev/null||true"
          }
        ]
      }
    ],
    "SubagentStop": [
      {
        "hooks": [
          {
            "type": "command",
            "command": "python3 -c \"import json,sys,os,subprocess; d=json.load(sys.stdin); sid=d.get('session_id',''); main=open('/tmp/.claude_main_session').read().strip() if os.path.exists('/tmp/.claude_main_session') else ''; (print(json.dumps({'decision':'block'})) or sys.exit(0)) if sid!=main or not sid else None; f='.claude/task.json'; tasks=json.load(open(f)).get('tasks',[]) if os.path.exists(f) else sys.exit(0); t=next((x for x in tasks if x['status']=='InProgress'),None); sys.exit(0) if not t else None; now=subprocess.check_output(['date','+%Y-%m-%d %H:%M:%S']).decode().strip(); print(json.dumps({'continue':True,'additionalSystemPrompt':'子代理已完成，请立即将当前进度写入 .claude/recording.md。时间戳直接使用：'+now+'（禁止伪造）。任务：Task#'+str(t['id'])+' '+t['description']+'。格式遵循 templates.md Session 格式。只写 recording.md，完成后停止。'}))\" 2>/dev/null||true"
          }
        ]
      }
    ],
    "Stop": [
      {
        "hooks": [
          {
            "type": "command",
            "command": "python3 -c \"import json,sys,os,time; LOCK='/tmp/.claude_recording_lock'; now_e=int(time.time()); last=int(open(LOCK).read()) if os.path.exists(LOCK) else 0; sys.exit(0) if now_e-last<60 else None; f='.claude/task.json'; tasks=json.load(open(f)).get('tasks',[]) if os.path.exists(f) else sys.exit(0); t=next((x for x in tasks if x['status']=='InProgress'),None); sys.exit(0) if not t else None; import subprocess; now=subprocess.check_output(['date','+%Y-%m-%d %H:%M:%S']).decode().strip(); open(LOCK,'w').write(str(now_e)); print(json.dumps({'continue':True,'additionalSystemPrompt':'请立即将当前进度写入 .claude/recording.md。时间戳直接使用：'+now+'（禁止伪造）。任务：Task#'+str(t['id'])+' '+t['description']+'。格式遵循 templates.md Session 格式。只写 recording.md，完成后停止。'}))\" 2>/dev/null||true"
          }
        ]
      },
      {
        "hooks": [
          {
            "type": "command",
            "command": "python3 -c \"import json,sys,os,platform; notify=lambda msg: (os.system('osascript -e \\\"display notification \\\\\\\"'+msg+'\\\\\\\" with title \\\\\\\"diwu-workflow\\\\\\\" sound name \\\\\\\"Glass\\\\\\\"\\\" 2>/dev/null') if platform.system()=='Darwin' else os.system('notify-send \\\"diwu-workflow\\\" \\\"'+msg+'\\\" 2>/dev/null')) or print('\\a',end='',flush=True); f='.claude/task.json'; tasks=json.load(open(f)).get('tasks',[]) if os.path.exists(f) else sys.exit(0); done_ids={t['id'] for t in tasks if t['status']=='Done'}; is_unblocked=lambda t: all(bid in done_ids for bid in t.get('blocked_by',[])); mk=lambda prefix,t: prefix+chr(10)+chr(10)+'Task#'+str(t['id'])+': '+t['description']+chr(10)+chr(10)+'验收条件：'+chr(10)+chr(10).join('  - '+a for a in t.get('acceptance',[]))+chr(10)+chr(10)+'实施步骤：'+chr(10)+chr(10).join('  '+str(i+1)+'. '+s for i,s in enumerate(t.get('steps',[])))+chr(10)+chr(10)+'按 core-workflow.md 流程执行。'; ip=[t for t in tasks if t['status']=='InProgress']; rc=sum(1 for t in tasks if t['status']=='InReview'); nx=[t for t in tasks if t['status']=='InSpec' and is_unblocked(t)]; (print(json.dumps({'decision':'block','reason':mk('继续完成当前任务：',ip[0])})) or sys.exit(0)) if ip else (notify('InReview 任务已达 '+str(rc)+' 个，请人工验收后继续') or sys.exit(0)) if rc>5 else ((print(json.dumps({'decision':'block','reason':mk('继续执行下一个任务：',nx[0])})) or sys.exit(0)) if nx else (notify('所有任务已完成') or sys.exit(0)))\" 2>/dev/null||true"
          }
        ]
      }
    ]
  }
}
