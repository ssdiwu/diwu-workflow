{
  "hooks": {
    "SessionStart": [
      {
        "hooks": [
          {
            "type": "command",
            "command": "python3 -c \"import json,sys,os; d=json.load(sys.stdin); sid=d.get('session_id',''); (open('/tmp/.claude_main_session','w').write(sid) if sid else None)\" 2>/dev/null||true"
          }
        ]
      }
    ],
    "PreToolUse": [
      {
        "matcher": "Bash",
        "hooks": [
          {
            "type": "command",
            "command": "python3 -c \"import json,sys,os; f='.claude/task.json'; d=json.load(open(f)) if os.path.exists(f) else sys.exit(0); t=next((x for x in d['tasks'] if x['status']=='InProgress'),None); t and print('[diwu] Task#'+str(t['id'])+': '+t.get('title',t.get('description',''))+((chr(10)+'  说明: '+t['description']) if t.get('description') else '')+chr(10)+chr(10).join('  - '+a for a in t.get('acceptance',[])))\" 2>/dev/null||true"
          }
        ]
      }
    ],
    "SubagentStop": [
      {
        "hooks": [
          {
            "type": "command",
            "command": "python3 -c \"import json,sys,os,subprocess; d=json.load(sys.stdin); sid=d.get('session_id',''); main=open('/tmp/.claude_main_session').read().strip() if os.path.exists('/tmp/.claude_main_session') else ''; sys.exit(0) if sid!=main or not sid else None; f='.claude/task.json'; tasks=json.load(open(f)).get('tasks',[]) if os.path.exists(f) else sys.exit(0); t=next((x for x in tasks if x['status']=='InProgress'),None); sys.exit(0) if not t else None; now=subprocess.check_output(['date','+%Y-%m-%d %H:%M:%S']).decode().strip(); print(json.dumps({'continue':True,'additionalSystemPrompt':'子代理已完成，请立即将当前进度写入 .claude/recording.md。时间戳直接使用：'+now+'（禁止伪造）。任务：Task#'+str(t['id'])+' '+t.get('title',t.get('description',''))+'。任务描述：'+t.get('description','')+'。格式遵循 templates.md Session 格式。只写 recording.md，完成后停止。'}))\" 2>/dev/null||true"
          }
        ]
      }
    ],
    "Stop": [
      {
        "hooks": [
          {
            "type": "command",
            "command": "python3 -c \"import json,sys,os,subprocess; d=json.load(sys.stdin); cwd=d.get('cwd','.'); rec=os.path.join(cwd,'.claude/recording.md'); sys.exit(0) if not os.path.exists(os.path.dirname(rec)) else None; f=os.path.join(cwd,'.claude/task.json'); tasks=(json.load(open(f)).get('tasks',[]) if os.path.exists(f) else []); active=[t for t in tasks if t['status'] not in ('Done','Cancelled')]; sys.exit(0) if not active else None; now=subprocess.check_output(['date','+%Y-%m-%d %H:%M:%S']).decode().strip(); lines=[('- '+t['status']+': Task#'+str(t['id'])+' '+t.get('title',t.get('description',''))[:40]) for t in active]; dc=sum(1 for t in tasks if t['status']=='Done'); (lines.append('- Done: '+str(dc)+' 个') if dc else None); snap=chr(10).join(lines); open(rec,'a').write(chr(10)+'## Session End '+now+chr(10)+chr(10)+snap+chr(10))\" 2>/dev/null||true",
            "run_in_background": true
          }
        ]
      },
      {
        "hooks": [
          {
            "type": "command",
            "command": "python3 -c \"import json,sys,os,platform,subprocess,re\\nnotify=lambda msg: (os.system('osascript -e \\\\\\\"display notification \\\\\\\"\\\\\\\"'+msg+'\\\\\\\"\\\\\\\" with title \\\\\\\"\\\\\\\"diwu-workflow\\\\\\\"\\\\\\\" sound name \\\\\\\"\\\\\\\"Glass\\\\\\\"\\\\\\\"\\\\\\\" 2>/dev/null') if platform.system()=='Darwin' else os.system('notify-send \\\\\\\"diwu-workflow\\\\\\\" \\\\\\\"'+msg+'\\\\\\\" 2>/dev/null')) or (open('/dev/tty','w').write('\\\\a') if os.path.exists('/dev/tty') else os.system('osascript -e \\\"beep\\\" 2>/dev/null'))\\nf='.claude/task.json'\\ntasks=json.load(open(f)).get('tasks',[]) if os.path.exists(f) else sys.exit(0)\\ndone_ids={t['id'] for t in tasks if t['status']=='Done'}\\nis_unblocked=lambda t: all(bid in done_ids for bid in t.get('blocked_by',[]))\\nmk=lambda prefix,t: prefix+chr(10)+chr(10)+'Task#'+str(t['id'])+': '+t.get('title',t.get('description',''))+chr(10)+'\\u4efb\\u52a1\\u63cf\\u8ff0\\uff1a'+t.get('description','')+chr(10)+chr(10)+'\\u9a8c\\u6536\\u6761\\u4ef6\\uff1a'+chr(10)+chr(10).join('  - '+a for a in t.get('acceptance',[]))+chr(10)+chr(10)+'\\u5b9e\\u65bd\\u6b65\\u9aa4\\uff1a'+chr(10)+chr(10).join('  '+str(i+1)+'. '+s for i,s in enumerate(t.get('steps',[])))+chr(10)+chr(10)+'\\u6309 core-workflow.md \\u6d41\\u7a0b\\u6267\\u884c\\u3002'\\nip=[t for t in tasks if t['status']=='InProgress']\\nrc=sum(1 for t in tasks if t['status']=='InReview')\\nnx=[t for t in tasks if t['status']=='InSpec' and is_unblocked(t)]\\ndef check_rec():\\n  rec='.claude/recording.md'\\n  if not os.path.exists(rec): return False\\n  content=open(rec).read()\\n  return bool(re.search(r'^## Session \\\\d{4}-\\\\d{2}-\\\\d{2} \\\\d{2}:\\\\d{2}:\\\\d{2}(?!\\\\s*(Start|End))',content,re.MULTILINE))\\nif ip:\\n  print(json.dumps({'decision':'block','reason':mk('\\u7ee7\\u7eed\\u5b8c\\u6210\\u5f53\\u524d\\u4efb\\u52a1\\uff1a',ip[0])})); sys.exit(0)\\nelif rc>5:\\n  notify('InReview \\u4efb\\u52a1\\u5df2\\u8fbe '+str(rc)+' \\u4e2a\\uff0c\\u8bf7\\u4eba\\u5de5\\u9a8c\\u6536\\u540e\\u7ee7\\u7eed'); sys.exit(0)\\nelif nx:\\n  print(json.dumps({'decision':'block','reason':mk('\\u7ee7\\u7eed\\u6267\\u884c\\u4e0b\\u4e00\\u4e2a\\u4efb\\u52a1\\uff1a',nx[0])})); sys.exit(0)\\nelif check_rec():\\n  notify('\\u6240\\u6709\\u4efb\\u52a1\\u5df2\\u5b8c\\u6210'); sys.exit(0)\\nelse:\\n  now=subprocess.check_output(['date','+%Y-%m-%d %H:%M:%S']).decode().strip()\\n  print(json.dumps({'decision':'block','reason':'\\u8bf7\\u5728\\u7ed3\\u675f\\u524d\\u66f4\\u65b0 .claude/recording.md\\uff0c\\u8bb0\\u5f55\\u672c\\u6b21 session \\u7684\\u5de5\\u4f5c\\u5185\\u5bb9\\u3002'+chr(10)+chr(10)+'\\u65f6\\u95f4\\u6233\\u76f4\\u63a5\\u4f7f\\u7528\\uff1a'+now+'\\uff08\\u7981\\u6b62\\u4f2a\\u9020\\uff0c\\u7981\\u6b62\\u5199\\\"\\uff08\\u7eed\\uff09\\\"\\u5360\\u4f4d\\u7b26\\uff09'+chr(10)+chr(10)+'\\u683c\\u5f0f\\u793a\\u4f8b\\uff1a'+chr(10)+'## Session '+now+chr(10)+chr(10)+'\\u8bb0\\u5f55\\u5185\\u5bb9\\uff1a\\u672c\\u6b21 session \\u7684\\u5de5\\u4f5c\\u5185\\u5bb9\\u3001\\u4efb\\u52a1\\u72b6\\u6001\\u3001\\u4e0b\\u4e00\\u6b65\\u3002'+chr(10)+chr(10)+'recording.md \\u5199\\u5b8c\\u540e\\u5373\\u53ef\\u6b63\\u5e38\\u7ed3\\u675f\\u5bf9\\u8bdd\\u3002'}))\\n\" 2>/dev/null||true"
          }
        ]
      }
    ]
  }
}
