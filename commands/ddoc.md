---
description: 产品文档工具，支持正向（需求→文档）和逆向（代码→文档）两种模式
argument-hint: [模式: forward|reverse（可选）]
allowed-tools: Read, Write, Edit, Glob, Bash
---

# /ddoc — 产品文档

## Step 1：确认模式与范围

询问用户（上下文已明确的跳过）：
1. **模式**：正向（有需求，要写文档）还是逆向（有代码，要还原文档）？
2. **范围**：整个产品 / 特定模块 / 特定功能？
3. **输入**：代码库路径（逆向）或需求描述（正向）
4. **输出结构**：领域驱动（推荐，有 3 个以上业务域时）还是分层（工具类产品或小项目）？

## Step 2A：正向模式（需求 → 文档）

按六步设计法处理需求：

1. **找约束**：从五个维度提取约束（业务/时序/跨端/并发/感知）
2. **定义原子**：识别不可再拆的最小单元（实体、状态、变换、事件）
3. **设计组合**：结构组合 / 管道组合 / 状态机组合
4. **划定边界**：领域边界 / 平台层边界 / 事实与投影
5. **设计降级路径**：列依赖链，每个依赖失败后的降级策略
6. **设计同步策略**：Source of Truth 位置、投影层数、冲突策略

输出按选定结构（领域驱动或分层）写入 `.doc/` 目录。

## Step 2B：逆向模式（代码 → 文档）

### 阶段 1：写文档 + 自审

读取代码库，按四层结构写文档：
1. **数据层**：实体、字段、关系、状态（用 erDiagram）
2. **接口层**：API 端点、入参、出参、错误码
3. **业务逻辑层**：核心规则、状态流转（用 stateDiagram-v2）、算法、边界条件
4. **产品层**：用户角色、核心旅程（用 flowchart）、权限、非功能需求

核心原则：代码是锚点，每条描述标注代码来源。无法确认的内容标注 `[待确认]`，不编造。

自审清单（交付前逐项检查）：
- [ ] 每个数据实体有完整字段列表？
- [ ] 每个 API 有入参和出参的具体格式？
- [ ] 每条业务规则有对应的异常情况处理？
- [ ] 每个用户流程覆盖了"失败路径"？
- [ ] 有无模糊表达（"等"、"类似"、"根据情况"）？
- [ ] 所有有状态的实体画了 stateDiagram-v2？
- [ ] 并发场景是否考虑？
- [ ] 核心业务流程有 flowchart？
- [ ] 数据实体关系有 erDiagram？

### 阶段 2：结构化 gap 分析

完成自审后，对文档进行两层完整性检查：

**第一层：结构检查**（每层是否有内容）
- 数据层：实体列表、字段定义、实体关系、查询模式
- 接口层：端点列表、入参格式、出参格式、认证方式、错误码
- 业务逻辑层：核心规则、状态机+转移表、关键算法、边界条件、图表
- 产品层：用户角色、核心旅程、权限矩阵、非功能需求

**第二层：深度检查**（每项是否够深）
对第一层已覆盖项，逐一用五约束维度检验：
- 业务约束：负面约束（"不能做什么"）写了吗？
- 时序约束：状态转移表画了吗？
- 跨端约束：多端相关概念有唯一定义吗？
- 并发约束：两用户/线程同时操作的策略写了吗？
- 感知约束：响应时间有具体阈值吗？

### 阶段 3：补充缺口（如有）

发现缺口时，回到代码库补充对应内容，再次执行 gap 分析直到无"否"项。

## Step 3：写入输出文件

### 领域驱动结构
```
.doc/
├── README.md          # 文件一览 + 任务→域文件映射表
├── constraints.md     # 全局约束（跨域共享）
├── [domain-a].md      # 域A：数据/接口/业务规则/状态机
├── [domain-b].md      # 域B：同上
└── setup.md           # 环境域：技术栈、依赖、本地配置
```

### 分层结构
```
.doc/
├── data.md            # 数据层
├── api.md             # 接口层
├── logic.md           # 业务逻辑层
└── product.md         # 产品层
```
